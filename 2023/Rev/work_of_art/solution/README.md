# Work of Art -- Solution

We're given a 64-bit Linux command line executable, let's run it, give it some input and see what happens. 

```
$ ./art_critic 
beep boop... I'm a robot art critic... please submit your masterpiece... beep boop
hello
This is bullsh*t
```

Rudeness of the problem author aside, we need to dig into the binary to discover what sort of input is expected here. Again, let's open the binary using a disassambler such as [IDA Free](https://hex-rays.com/ida-free/). The binary is stripped, so there's no function names or other debug information to guide us. Additionally, it's statically linked so the entire libc is mixed in the binary with the "user code".

First order of business is to identify and separate the tool logic from the libc, e.g., find the `main` function. Two approaches are useful here: we can start with the `_start` symbol (the entry code to the binary) and trace the calls forward until we reach something that looks like user code. Alternativelly, we can start with the error message and trace back the references. Using either (or both) approaches, we identify the following candidate for the main function.

```c
.text:00000000004006F0 sub_4006F0      proc near               ; DATA XREF: start+1D↓o
.text:00000000004006F0 ; __unwind {
.text:00000000004006F0                 sub     rsp, 8
.text:00000000004006F4                 call    sub_4010B0
.text:00000000004006F9                 call    sub_4012D0
.text:00000000004006FE                 call    sub_401470
.text:00000000004006FE ; } // starts at 4006F0
.text:00000000004006FE sub_4006F0      endp
```

Instead of disassembling each function, we can try to step through the main function, analyse the behaviour of the three functions and, hopefully, obtain some hints on their logic. 

After some experimenting it turns out `sub_4010B0` is responsible for reading and parsing input -- if we enter a string such as `"hello"`, the function terminates the program with an error message, but if we enter an integer `1` it seems to be waiting for more input. After feeding it more integers, the function eventually returns.

```
$ gdb ./art_critic -ex "b *0x4006F9" -ex "run"
...
[*] Failed to find objfile or not a valid file format: [Errno 2] No such file or directory: 'system-supplied DSO at 0x7ffff7ffd000'
beep boop... I'm a robot art critic... please submit your masterpiece... beep boop
hello
This is bullsh*t
[Inferior 1 (process 4065) exited normally]

$ gdb ./art_critic -ex "b *0x4006F9" -ex "run"
...
[*] Failed to find objfile or not a valid file format: [Errno 2] No such file or directory: 'system-supplied DSO at 0x7ffff7ffd000'
beep boop... I'm a robot art critic... please submit your masterpiece... beep boop
1
2
3
4

Breakpoint 1, 0x00000000004006f9 in ?? ()
```

A reasonable assumption, therefore, is that the `sub_4010B0` function reads a sequence of integers from the input.

Let's move on to the next function. Setting a breakpoint after the function and running with some input (e.g., `echo 1 2 3 4 | gdb ./art_critic -ex "b *0x4006FE" -ex "run"`): gives us the following CPU state on function exit:
```c
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x7               
$rbx   : 0x000000004004a8  →   sub rsp, 0x8
$rcx   : 0x8               
$rdx   : 0x2e              
$rsp   : 0x007fffffffe530  →  0x000000004004a8  →   sub rsp, 0x8
$rbp   : 0x0000000049c450  →   push r15
$rsi   : 0x30              
$rdi   : 0x000000007bfa28  →  "+---+---+ |"
$rip   : 0x000000004006fe  →   call 0x401470
$r8    : 0x000000007bc140  →  0x2b2d2d2d2b2e2e ("..+---+"?)
$r9    : 0x8               
$r10   : 0x6               
$r11   : 0x000000007be6a0  →  "......+---+"
$r12   : 0x0000000049c4f0  →   push rbp
$r13   : 0x0               
$r14   : 0x000000007bc018  →  0x000000004de410  →   mov ecx, edi
$r15   : 0x0               
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x007fffffffe530│+0x0000: 0x000000004004a8  →   sub rsp, 0x8     ← $rsp
0x007fffffffe538│+0x0008: 0x0000000049bce9  →   mov edi, eax
0x007fffffffe540│+0x0010: 0x0000000000000000
0x007fffffffe548│+0x0018: 0x0000000100000000
0x007fffffffe550│+0x0020: 0x007fffffffe658  →  0x007fffffffe87a  →  "/src/art_critic"
0x007fffffffe558│+0x0028: 0x000000004006f0  →   sub rsp, 0x8
0x007fffffffe560│+0x0030: 0x0000000000000000
0x007fffffffe568│+0x0038: 0x0000009a00000006
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4006f0                  sub    rsp, 0x8
     0x4006f4                  call   0x4010b0
     0x4006f9                  call   0x4012d0
 →   0x4006fe                  call   0x401470
   ↳    0x401470                  push   r15
        0x401472                  push   r14
        0x401474                  push   r13
        0x401476                  push   r12
        0x401478                  lea    r13, [rip+0x3bd221]        # 0x7be6a0
        0x40147f                  push   rbp
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── arguments (guessed) ────
0x401470 (
   $rdi = 0x000000007bfa28 → "+---+---+ |",
   $rsi = 0x00000000000030,
   $rdx = 0x0000000000002e
)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "art_critic", stopped 0x4006fe in ?? (), reason: BREAKPOINT
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x4006fe → call 0x401470
[#1] 0x49bce9 → mov edi, eax
[#2] 0x400f3a → hlt 
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  
```

We imediatelly notice that some registers contain pointers to interesting strings (e.g., `"+---+---+ |"`). Digging around the memory, we find that starting from the pointer stored in `r11` (`0x7be6a0`), there is a similar looking string every 1000 bytes. Looking at the same address in IDA reveals that it is referenced from the three functions we're analysing. 
```c
.bss:00000000007BE6A0 unk_7BE6A0      db    ? ;               ; DATA XREF: sub_4010B0+1B7↑o
.bss:00000000007BE6A0                                         ; sub_4012D0+14↑o ...
```

Moreove, its usage in the `sub_4012D0` suggests that the address contains a two-dimensional array with rows of size 1000. 
```c
...
                for ( result = 0LL; result != 7; ++result )
                {
                  v17 = asc_7BC140[result + i];
                  if ( v17 != 46 )
                    byte_7BE6A0[1000 * v15 + v12 + (int)result] = v17;
                }
                ++v15;
...
```

After renaming and retyping the label in IDA, we investigate what is at address `asc_7BC140` and it becomes apparent what's going on in that code snippet -- some ASCII art cubes are being copied to the 1000 by 1000 char array. We will rename the array to "canvas".
```c
              for ( i = 0LL; i != 48; i += 8LL )
              {
                for ( j = 0LL; j != 7; ++j )
                {
                  v17 = asc_7BC140[j + i];
                  if ( v17 != 46 )
                    canvas_byte_7BE6A0[v15][v12 + (int)j] = v17;
                }
                ++v15;
              }
...
.data:00000000007BC140 asc_7BC140      db '..+---+',0          ; DATA XREF: sub_4010B0+1B0↑o
.data:00000000007BC140                                         ; sub_4012D0+7F↑o
.data:00000000007BC148                 db './   /|',0
.data:00000000007BC150                 db '+---+ |',0
.data:00000000007BC158                 db '|   | +',0
.data:00000000007BC160                 db '|   |/.',0
.data:00000000007BC168                 db '+---+..',0
```

Next step is to try to extract the canvas (from the memory of the running program) and visualizing it. Fortunatelly, that can be done with a one-liner.
```bash
$ echo 1 2 3 4 | gdb ./art_critic -ex "b *0x4006FE" -ex "run" -ex "dump binary memory canvas.bin 0x000000007be6a0 0x000000007be6a0+(1000*1000)" -ex "quit" && strings canvas.bin 
......+---+
...../   /|
....+---+ |
..+-|   | +
./  |   |/|
+---+---+ |
|   |   | +
|   |   |/|
+---+---+ |
|   |   | +
|   |   |/|
+---+---+ |
|   |   | +
|   |   |/.
+---+---+..
```

After a few more experiments we conclude the following: the tool receives a two dimensional array of integers as input and builds an ASCII art consisting of towers whose heights correspond to the input.

Now we turn our attention to the third function. Behaviour analysis doesn't really get us anywhere, every ASCII art we generate is apparently bullsh*t. No choice but to decompile the function and dig in.

In this writeup, we skip the somewhat tedious process of figuring out what the parts of the C code seem to be doing. After we perform the analysis (while making a few reasonable assumptions along the way), we rename variables according to their supposed purpose and obtain the following:
```c
void __noreturn sub_401470()
{
  int *expected_values_interator; // rbp
  int *modulus_iterator; // r12
  __int64 v2; // rbx
  int modulus; // esi
  char *column_iterator; // rdi
  char v5; // dl
  int column_hash; // ecx
  __int64 power; // r9
  char *v8; // r8
  char current_character; // al
  _DWORD *v10; // rsi
  __int64 i; // rax
  int v12; // [rsp+Ch] [rbp-5Ch] BYREF
  __int64 v13; // [rsp+10h] [rbp-58h] BYREF
  _DWORD *column_hashes_iterator; // [rsp+18h] [rbp-50h]
  _DWORD *v15; // [rsp+20h] [rbp-48h]
  unsigned __int64 v16; // [rsp+28h] [rbp-40h]

  expected_values_interator = (int *)&array_of_expected_values_unk_561420;
  modulus_iterator = array_of_modules_unk_563B90;
  v16 = __readfsqword(0x28u);
  while ( 1 )
  {
    v13 = 0LL;
    column_hashes_iterator = 0LL;
    v15 = 0LL;
    if ( dword_8B28E0 <= 0 )
      break;
    v2 = 0LL;
    do
    {
      v12 = 0;
      if ( dword_8B28E4 > 0 )
      {
        modulus = *modulus_iterator;
        column_iterator = &canvas_byte_7BE6A0[0][v2];
        v5 = 0;
        column_hash = 0;
        power = 1LL;
        v8 = &canvas_byte_7BE6A0[(unsigned int)(dword_8B28E4 - 1) + 1][v2];
        do
        {
          current_character = *column_iterator;
          if ( *column_iterator != '+' )
          {
            switch ( current_character )
            {
              case '|':
                column_hash += (int)power % modulus;
                break;
              case '.':
                column_hash += 2 * (int)power % modulus;
                break;
              case '-':
                column_hash += 3 * (int)power % modulus;
                break;
              case '/':
                column_hash += 4 * (int)power % modulus;
                break;
              case ' ':
                column_hash += 5 * (int)power % modulus;
                break;
              default:
                if ( v5 )
                  v12 = column_hash;
                _assert_fail("false", "art_critic.cpp", 253LL, "int dig(char)", v8, power);
            }
          }
          if ( column_hash >= 0 )
          {
            if ( modulus <= column_hash )
              column_hash -= modulus;
          }
          else
          {
            column_hash += modulus;
          }
          column_iterator += 1000;
          power = (unsigned int)(6 * (int)power % modulus);
          v5 = 1;
        }
        while ( v8 != column_iterator );
        v12 = column_hash;
      }
      if ( column_hashes_iterator == v15 )
      {
        sub_4016F0(&v13, (__int64)column_hashes_iterator, (unsigned int *)&v12);
      }
      else
      {
        v10 = column_hashes_iterator + 1;
        *column_hashes_iterator = v12;
        column_hashes_iterator = v10;
      }
      ++v2;
    }
    while ( dword_8B28E0 > (int)v2 );
    if ( dword_8B28E0 != 631 )
      break;
    for ( i = 0LL; i != 631; ++i )
    {
      if ( *(_DWORD *)(v13 + i * 4) != expected_values_interator[i] )
        _chk_fail_0();
    }
    sub_401820(v13);
    expected_values_interator += 631;
    ++modulus_iterator;
    if ( expected_values_interator == array_of_modules_unk_563B90 )
      _chk_fail_1();
  }
  _chk_fail_0();
}
```

The function seems to doing the following:
- It considers the ASCII art column by column
- It calculates something resembling a [polynomial rolling hash](https://byby.dev/polynomial-rolling-hash) for the column
- It compares the resulting column hash with an expected value embedded in the binary

The procedure is repeated for 4 hash modulus values embedded in the binary (at offset `0x563B90`). Also, for each of the 4 moduli, there are 631 expected column hash values embedded in the binary (starting at offset `0x561420`). All moduli and expected values can be easily extracted using the IDA's "Export data" feature. 

The goal now is to build the ASCII art that satisfy the constrains of the function. It is important to notice that the hash value is simply the remainder modulo the corresponding modulus when the column string is interpreted as an integer in base 6. Given four reminders and four moduli, we can uniquely determine the value (modulo the product of the moduli) using the [Chinese reminder theorem](https://en.wikipedia.org/wiki/Chinese_remainder_theorem). The value is then converted to base 6 and digits replaced by characters according to the substitution we can read out from the source code above.

The script below build and prints out the column values that match the exected values.
```python
import libnum

CHAR_ORDER = "+|.-/ "

NCOLS = 631

MODULUS = [13, 1103, 2633, 3271]

EXPECTED = [
     [1,  1,  1,  1,  1,  1,  1,  1,  6,  2,  5,  5,  1,  3,  9,  2,  8,  7,  5,
     12, 5,  12, 2,  5,  5,  12, 2,  5,  12, 12, 9,  1,  10, 6,  12, 5,  1,  9,
     10, 2,  1,  10, 10, 10, 1,  11, 9,  6,  6,  5,  1,  2,  8,  2,  7,  6,  12,
     1,  1,  1,  1,  1,  1,  1,  6,  2,  5,  5,  1,  3,  9,  2,  8,  7,  5,  12,
     5,  12, 2,  5,  5,  12, 2,  5,  12, 12, 9,  1,  10, 6,  12, 5,  1,  7,  8,
     11, 4,  2,  9,  0,  0,  9,  3,  1,  1,  1,  1,  1,  9,  0,  11, 5,  12, 2,
     4,  5,  1,  10, 4,  6,  12, 11, 2,  5,  12, 12, 9,  1,  10, 6,  12, 5,  1,
     7,  8,  11, 4,  2,  9,  0,  0,  9,  3,  1,  1,  1,  1,  1,  8,  5,  4,  1,
     10, 6,  12, 5,  1,  7,  8,  11, 4,  6,  5,  5,  1,  3,  9,  2,  8,  7,  5,
     12, 12, 12, 9,  1,  10, 7,  11, 12, 2,  6,  5,  0,  8,  4,  11, 5,  10, 2,
     4,  0,  10, 7,  11, 12, 2,  6,  5,  12, 12, 12, 9,  1,  10, 6,  12, 5,  1,
     7,  8,  11, 12, 2,  10, 3,  3,  11, 9,  10, 9,  11, 8,  4,  4,  2,  9,  0,
     0,  8,  4,  0,  0,  8,  4,  0,  0,  9,  3,  1,  8,  5,  4,  1,  10, 6,  12,
     5,  1,  7,  8,  11, 4,  2,  9,  0,  0,  9,  3,  1,  1,  1,  1,  1,  8,  5,
     4,  1,  10, 7,  11, 12, 2,  6,  5,  12, 5,  8,  6,  1,  1,  1,  1,  1,  12,
     11, 5,  0,  8,  4,  11, 5,  10, 2,  4,  0,  8,  9,  3,  4,  0,  10, 10, 7,
     9,  0,  10, 11, 11, 12, 7,  10, 11, 2,  2,  6,  12, 11, 2,  5,  5,  8,  6,
     1,  8,  5,  4,  1,  10, 6,  12, 5,  1,  9,  10, 2,  1,  10, 10, 10, 1,  10,
     10, 10, 1,  9,  7,  5,  5,  12, 2,  5,  12, 12, 9,  0,  0,  8,  4,  0,  0,
     8,  4,  0,  0,  8,  4,  0,  0,  9,  3,  1,  8,  5,  4,  0,  0,  9,  3,  4,
     0,  10, 10, 7,  9,  0,  10, 11, 11, 9,  10, 1,  2,  4,  5,  11, 9,  3,  8,
     4,  8,  4,  11, 5,  10, 2,  4,  0,  8,  9,  3,  1,  8,  5,  4,  0,  8,  6,
     12, 12, 1,  9,  10, 2,  1,  10, 10, 10, 1,  10, 10, 3,  3,  11, 9,  10, 2,
     7,  5,  5,  12, 12, 9,  1,  10, 6,  12, 5,  1,  7,  8,  11, 4,  6,  5,  4,
     4,  6,  5,  4,  4,  7,  4,  5,  5,  12, 2,  5,  12, 12, 9,  1,  10, 7,  11,
     12, 2,  6,  5,  12, 12, 12, 9,  1,  10, 7,  11, 12, 9,  10, 8,  11, 4,  2,
     9,  0,  0,  8,  4,  0,  0,  8,  4,  0,  0,  9,  3,  1,  8,  5,  4,  0,  0,
     9,  3,  4,  0,  10, 10, 7,  9,  0,  10, 11, 11, 9,  10, 1,  2,  4,  5,  11,
     9,  3,  8,  4,  8,  4,  11, 5,  10, 2,  4,  0,  8,  9,  3,  1,  1,  1,  1,
     1,  8,  5,  4,  1,  10, 7,  11, 12, 2,  3,  9,  11, 3,  10, 10, 3,  1,  9,
     7,  0,  4,  2,  5,  12, 5,  8,  6,  1,  1,  1,  1,  1,  6,  2,  5,  5,  1,
     3,  9,  2,  8,  7,  5,  12, 5,  12, 2,  5,  5,  12, 2,  5,  12, 12, 9,  0,
     0,  9,  3,  4,  11, 7,  1,  2,  8,  4,  10, 11, 9,  12, 7,  1,  1,  1,  1,
     1,  1,  1,  1],

    [576,  576, 576,  576,  576,  576, 576,  576,  603,  728, 823,  718,
     1095, 591, 908,  933,  1075, 279, 957,  261,  4,    804, 807,  810,
     4,    804, 807,  810,  622,  553, 116,  484,  564,  10,  23,   501,
     196,  899, 723,  330,  454,  900, 723,  546,  454,  205, 908,  770,
     788,  483, 688,  933,  1075, 189, 933,  242,  1088, 576, 576,  576,
     576,  576, 576,  576,  603,  728, 823,  718,  1095, 591, 908,  933,
     1075, 279, 957,  261,  4,    804, 807,  810,  4,    804, 807,  810,
     622,  553, 116,  484,  564,  10,  23,   501,  196,  456, 973,  621,
     227,  300, 116,  936,  799,  656, 777,  576,  576,  576, 576,  576,
     122,  267, 208,  67,   922,  203, 906,  501,  196,  256, 39,   242,
     1088, 803, 807,  810,  622,  553, 116,  484,  564,  10,  23,   501,
     196,  456, 973,  621,  227,  300, 116,  936,  799,  656, 777,  576,
     576,  576, 576,  576,  91,   501, 592,  484,  564,  10,  23,   501,
     196,  456, 973,  621,  227,  476, 823,  718,  1095, 591, 908,  933,
     1075, 279, 957,  261,  622,  553, 116,  484,  564,  418, 208,  878,
     1056, 278, 957,  1082, 1075, 54,  884,  535,  634,  203, 906,  814,
     564,  418, 208,  878,  1056, 278, 957,  261,  622,  553, 116,  484,
     564,  10,  23,   501,  196,  456, 973,  621,  896,  183, 723,  772,
     653,  205, 908,  46,   829,  204, 973,  67,   227,  300, 116,  936,
     799,  248, 592,  936,  799,  248, 592,  936,  799,  656, 777,  576,
     91,   501, 592,  484,  564,  10,  23,   501,  196,  456, 973,  621,
     227,  300, 116,  936,  799,  656, 777,  576,  576,  576, 576,  576,
     91,   501, 592,  484,  564,  418, 208,  878,  1056, 278, 957,  261,
     4,    628, 100,  576,  576,  576, 576,  576,  1088, 803, 957,  1082,
     1075, 54,  884,  535,  634,  203, 906,  814,  365,  656, 777,  482,
     699,  586, 429,  88,   122,  267, 1039, 515,  480,  685, 257,  1027,
     68,   176, 941,  242,  1088, 803, 807,  810,  4,    628, 100,  576,
     91,   501, 592,  484,  564,  10,  23,   501,  196,  899, 723,  330,
     454,  900, 723,  546,  454,  900, 723,  546,  454,  865, 55,   810,
     4,    804, 807,  810,  622,  553, 116,  936,  799,  248, 592,  936,
     799,  248, 592,  936,  799,  248, 592,  936,  799,  656, 777,  576,
     91,   501, 592,  936,  799,  656, 777,  482,  699,  586, 429,  88,
     122,  267, 1039, 515,  480,  460, 1039, 947,  1056, 41,  620,  983,
     192,  53,  636,  1002, 1075, 54,  884,  535,  634,  203, 906,  814,
     365,  656, 777,  576,  91,   501, 592,  936,  365,  10,  23,   275,
     196,  899, 723,  330,  454,  900, 723,  546,  454,  900, 723,  772,
     653,  205, 908,  46,   211,  279, 957,  810,  622,  553, 116,  484,
     564,  10,  23,   501,  196,  456, 973,  621,  227,  476, 823,  67,
     227,  476, 823,  67,   227,  884, 1008, 810,  4,    804, 807,  810,
     622,  553, 116,  484,  564,  418, 208,  878,  1056, 278, 957,  261,
     622,  553, 116,  484,  564,  418, 208,  878,  571,  203, 973,  621,
     227,  300, 116,  936,  799,  248, 592,  936,  799,  248, 592,  936,
     799,  656, 777,  576,  91,   501, 592,  936,  799,  656, 777,  482,
     699,  586, 429,  88,   122,  267, 1039, 515,  480,  460, 1039, 947,
     1056, 41,  620,  983,  192,  53,  636,  1002, 1075, 54,  884,  535,
     634,  203, 906,  814,  365,  656, 777,  576,  576,  576, 576,  576,
     91,   501, 592,  484,  564,  418, 208,  878,  1056, 53,  908,  554,
     653,  900, 723,  772,  454,  865, 55,   1082, 87,   189, 957,  261,
     4,    628, 100,  576,  576,  576, 576,  576,  603,  728, 823,  718,
     1095, 591, 908,  933,  1075, 279, 957,  261,  4,    804, 807,  810,
     4,    804, 807,  810,  622,  553, 116,  936,  799,  656, 777,  482,
     108,  813, 688,  933,  1075, 54,  612,  983,  192,  685, 257,  576,
     576,  576, 576,  576,  576,  576, 576],

    [746,  746,  746,  746,  746,  746,  746,  746,  1892, 1955, 1007, 1972,
     1379, 2109, 330,  2028, 734,  2317, 672,  643,  2060, 2575, 2578, 2581,
     2060, 2575, 2578, 2581, 1911, 855,  1332, 137,  65,   1419, 623,  758,
     849,  778,  1323, 1651, 4,    779,  1323, 1867, 4,    2150, 330,  670,
     117,  1625, 822,  2028, 734,  994,  648,  624,  2041, 746,  746,  746,
     746,  746,  746,  746,  1892, 1955, 1007, 1972, 1379, 2109, 330,  2028,
     734,  2317, 672,  643,  2060, 2575, 2578, 2581, 2060, 2575, 2578, 2581,
     1911, 855,  1332, 137,  65,   1419, 623,  758,  849,  1935, 1734, 991,
     22,   617,  1332, 1094, 1341, 1260, 815,  746,  746,  746,  746,  746,
     1845, 134,  2263, 2600, 992,  82,   1115, 758,  849,  1495, 725,  624,
     2041, 2574, 2578, 2581, 1911, 855,  1332, 137,  65,   1419, 623,  758,
     849,  1935, 1734, 991,  22,   617,  1332, 1094, 1341, 1260, 815,  746,
     746,  746,  746,  746,  597,  127,  1808, 137,  65,   1419, 623,  758,
     849,  1935, 1734, 991,  22,   1718, 1007, 1972, 1379, 2109, 330,  2028,
     734,  2317, 672,  643,  1911, 855,  1332, 137,  65,   157,  2263, 1973,
     715,  2316, 672,  784,  734,  2127, 306,  435,  704,  82,   1115, 2032,
     65,   157,  2263, 1973, 715,  2316, 672,  643,  1911, 855,  1332, 137,
     65,   1419, 623,  758,  849,  1935, 1734, 991,  660,  738,  1323, 1029,
     723,  2150, 330,  2244, 2354, 1698, 1734, 296,  22,   617,  1332, 1094,
     1341, 2522, 1808, 1094, 1341, 2522, 1808, 1094, 1341, 1260, 815,  746,
     597,  127,  1808, 137,  65,   1419, 623,  758,  849,  1935, 1734, 991,
     22,   617,  1332, 1094, 1341, 1260, 815,  746,  746,  746,  746,  746,
     597,  127,  1808, 137,  65,   157,  2263, 1973, 715,  2316, 672,  643,
     2060, 1474, 270,  746,  746,  746,  746,  746,  2041, 2574, 672,  784,
     734,  2127, 306,  435,  704,  82,   1115, 2032, 1979, 1260, 815,  2411,
     2092, 2511, 2591, 614,  1845, 134,  52,   1307, 139,  1620, 2605, 729,
     873,  981,  656,  624,  2041, 2574, 2578, 2581, 2060, 1474, 270,  746,
     597,  127,  1808, 137,  65,   1419, 623,  758,  849,  778,  1323, 1651,
     4,    779,  1323, 1867, 4,    779,  1323, 1867, 4,    674,  741,  2581,
     2060, 2575, 2578, 2581, 1911, 855,  1332, 1094, 1341, 2522, 1808, 1094,
     1341, 2522, 1808, 1094, 1341, 2522, 1808, 1094, 1341, 1260, 815,  746,
     597,  127,  1808, 1094, 1341, 1260, 815,  2411, 2092, 2511, 2591, 614,
     1845, 134,  52,   1307, 139,  1430, 52,   1739, 715,  2114, 736,  1775,
     2484, 2126, 752,  1794, 734,  2127, 306,  435,  704,  82,   1115, 2032,
     1979, 1260, 815,  746,  597,  127,  1808, 1094, 1979, 1419, 623,  1596,
     849,  778,  1323, 1651, 4,    779,  1323, 1867, 4,    779,  1323, 1029,
     723,  2150, 330,  2244, 2503, 2317, 672,  2581, 1911, 855,  1332, 137,
     65,   1419, 623,  758,  849,  1935, 1734, 991,  22,   1718, 1007, 296,
     22,   1718, 1007, 296,  22,   456,  14,   2581, 2060, 2575, 2578, 2581,
     1911, 855,  1332, 137,  65,   157,  2263, 1973, 715,  2316, 672,  643,
     1911, 855,  1332, 137,  65,   157,  2263, 1973, 566,  1697, 1734, 991,
     22,   617,  1332, 1094, 1341, 2522, 1808, 1094, 1341, 2522, 1808, 1094,
     1341, 1260, 815,  746,  597,  127,  1808, 1094, 1341, 1260, 815,  2411,
     2092, 2511, 2591, 614,  1845, 134,  52,   1307, 139,  1430, 52,   1739,
     715,  2114, 736,  1775, 2484, 2126, 752,  1794, 734,  2127, 306,  435,
     704,  82,   1115, 2032, 1979, 1260, 815,  746,  746,  746,  746,  746,
     597,  127,  1808, 137,  65,   157,  2263, 1973, 715,  2126, 330,  454,
     723,  779,  1323, 1029, 4,    674,  741,  784,  892,  994,  672,  643,
     2060, 1474, 270,  746,  746,  746,  746,  746,  1892, 1955, 1007, 1972,
     1379, 2109, 330,  2028, 734,  2317, 672,  643,  2060, 2575, 2578, 2581,
     2060, 2575, 2578, 2581, 1911, 855,  1332, 1094, 1341, 1260, 815,  2411,
     754,  1706, 822,  2028, 734,  2127, 728,  1775, 2484, 1620, 2605, 746,
     746,  746,  746,  746,  746,  746,  746],

    [3009, 3009, 3009, 3009, 3009, 3009, 3009, 3009, 1075, 345,  179,  2221,
     2630, 2989, 2175, 1028, 623,  2590, 1761, 2997, 2247, 2286, 2289, 2292,
     2247, 2286, 2289, 2292, 1094, 1159, 423,  2938, 121,  1882, 2032, 2688,
     1362, 603,  2732, 1373, 517,  604,  2732, 1589, 517,  397,  2175, 432,
     2046, 1093, 510,  1028, 623,  107,  1737, 2978, 2228, 3009, 3009, 3009,
     3009, 3009, 3009, 3009, 1075, 345,  179,  2221, 2630, 2989, 2175, 1028,
     623,  2590, 1761, 2997, 2247, 2286, 2289, 2292, 2247, 2286, 2289, 2292,
     1094, 1159, 423,  2938, 121,  1882, 2032, 2688, 1362, 2327, 2922, 2395,
     1922, 2752, 423,  2407, 2684, 2455, 342,  3009, 3009, 3009, 3009, 3009,
     1572, 211,  1475, 3000, 1848, 3178, 367,  2688, 1362, 2811, 2349, 2978,
     2228, 2285, 2289, 2292, 1094, 1159, 423,  2938, 121,  1882, 2032, 2688,
     1362, 2327, 2922, 2395, 1922, 2752, 423,  2407, 2684, 2455, 342,  3009,
     3009, 3009, 3009, 3009, 1856, 1069, 899,  2938, 121,  1882, 2032, 2688,
     1362, 2327, 2922, 2395, 1922, 1939, 179,  2221, 2630, 2989, 2175, 1028,
     623,  2590, 1761, 2997, 1094, 1159, 423,  2938, 121,  1675, 1475, 973,
     604,  2589, 1761, 3168, 623,  2204, 2151, 197,  1560, 3178, 367,  529,
     121,  1675, 1475, 973,  604,  2589, 1761, 2997, 1094, 1159, 423,  2938,
     121,  1882, 2032, 2688, 1362, 2327, 2922, 2395, 1568, 3196, 2732, 2959,
     1579, 397,  2175, 1244, 1877, 650,  2922, 1690, 1922, 2752, 423,  2407,
     2684, 2662, 899,  2407, 2684, 2662, 899,  2407, 2684, 2455, 342,  3009,
     1856, 1069, 899,  2938, 121,  1882, 2032, 2688, 1362, 2327, 2922, 2395,
     1922, 2752, 423,  2407, 2684, 2455, 342,  3009, 3009, 3009, 3009, 3009,
     1856, 1069, 899,  2938, 121,  1675, 1475, 973,  604,  2589, 1761, 2997,
     2247, 3099, 2533, 3009, 3009, 3009, 3009, 3009, 2228, 2285, 1761, 3168,
     623,  2204, 2151, 197,  1560, 3178, 367,  529,  2330, 2455, 342,  411,
     588,  3174, 365,  2085, 1572, 211,  2124, 2741, 28,   1893, 1061, 3113,
     3257, 94,   1745, 2978, 2228, 2285, 2289, 2292, 2247, 3099, 2533, 3009,
     1856, 1069, 899,  2938, 121,  1882, 2032, 2688, 1362, 603,  2732, 1373,
     517,  604,  2732, 1589, 517,  604,  2732, 1589, 517,  2121, 2365, 2292,
     2247, 2286, 2289, 2292, 1094, 1159, 423,  2407, 2684, 2662, 899,  2407,
     2684, 2662, 899,  2407, 2684, 2662, 899,  2407, 2684, 2455, 342,  3009,
     1856, 1069, 899,  2407, 2684, 2455, 342,  411,  588,  3174, 365,  2085,
     1572, 211,  2124, 2741, 28,   1507, 2124, 3173, 604,  2191, 2808, 3209,
     3011, 2203, 2824, 3228, 623,  2204, 2151, 197,  1560, 3178, 367,  529,
     2330, 2455, 342,  3009, 1856, 1069, 899,  2407, 2330, 1882, 2032, 1318,
     1362, 603,  2732, 1373, 517,  604,  2732, 1589, 517,  604,  2732, 2959,
     1579, 397,  2175, 1244, 3030, 2590, 1761, 2292, 1094, 1159, 423,  2938,
     121,  1882, 2032, 2688, 1362, 2327, 2922, 2395, 1922, 1939, 179,  1690,
     1922, 1939, 179,  1690, 1922, 1732, 2893, 2292, 2247, 2286, 2289, 2292,
     1094, 1159, 423,  2938, 121,  1675, 1475, 973,  604,  2589, 1761, 2997,
     1094, 1159, 423,  2938, 121,  1675, 1475, 973,  2722, 649,  2922, 2395,
     1922, 2752, 423,  2407, 2684, 2662, 899,  2407, 2684, 2662, 899,  2407,
     2684, 2455, 342,  3009, 1856, 1069, 899,  2407, 2684, 2455, 342,  411,
     588,  3174, 365,  2085, 1572, 211,  2124, 2741, 28,   1507, 2124, 3173,
     604,  2191, 2808, 3209, 3011, 2203, 2824, 3228, 623,  2204, 2151, 197,
     1560, 3178, 367,  529,  2330, 2455, 342,  3009, 3009, 3009, 3009, 3009,
     1856, 1069, 899,  2938, 121,  1675, 1475, 973,  604,  2203, 2175, 216,
     1579, 604,  2732, 2959, 517,  2121, 2365, 3168, 5,    107,  1761, 2997,
     2247, 3099, 2533, 3009, 3009, 3009, 3009, 3009, 1075, 345,  179,  2221,
     2630, 2989, 2175, 1028, 623,  2590, 1761, 2997, 2247, 2286, 2289, 2292,
     2247, 2286, 2289, 2292, 1094, 1159, 423,  2407, 2684, 2455, 342,  411,
     3078, 2450, 510,  1028, 623,  2204, 2800, 3209, 3011, 1893, 1061, 3009,
     3009, 3009, 3009, 3009, 3009, 3009, 3009]
]

def num_to_column(x):
    r = ''
    while x > 0:
        r += CHAR_ORDER[x%6]
        x //= 6
    return r

cols = []
for i in range(NCOLS):
    sol = libnum.solve_crt([EXPECTED[j][i] for j in range(4)], MODULUS)
    cols.append(num_to_column(sol))

nrows = max(len(x) for x in cols)
for i in range(len(cols)):
    cols[i] += '#'*(nrows-len(cols[i]))

rows = []
for i in range(len(cols[0])):
    rows.append(''.join(x[i] for x in cols))

print('\n'.join(rows))
```

Running the script, somewhat suprisingly, gives us the flag! Turns out, only the understanding of the third function was needed to solve the problem. It contained validity checks for an ASCII art, and valid ASCII art contains the flag characters.

```
..........+---+---+---+---+---+.......+---+---+---+---+...........+---+---+---+---+---+.......+---+.......................+---+.......+---+...................+---+---+---+---+.......+---+...........+---+.......+---+---+---+---+.......................+---+...................+---+.......+---+...........................+---+...........+---+---+---+---+---+...........................................+---+...................+---+---+---+---+---+.......+---+---+---+---+---+.......+---+.......+---+.......................................+---+.......................+---+---+---+---+.......+---+---+---+---+---+.......+---+............
........./   /   /   /   /   /|....../   /   /   /   /|........../   /   /   /   /   /|....../   /|....................../   /|....../   /|................../   /   /   /   /|....../   /|........../   /|....../   /   /   /   /|....................../   /|................../   /|....../   /|........................../   /|........../   /   /   /   /   /|........................................../   /|................../   /   /   /   /   /|....../   /   /   /   /   /|....../   /|....../   /|....................................../   /|....................../   /   /   /   /|....../   /   /   /   /   /|....../   /|............
........+---+---+---+---+---+ |.....+---+---+---+---+---+.......+---+---+---+---+---+ |.....+---+ |.................+---+---+ |.....+---+ |.................+---+---+---+---+ |.....+---+---+.......+---+ |.....+---+---+---+---+ |.....................+---+ |.................+---+ |.....+---+---+...................+---+---+ |.........+---+---+---+---+---+ |.....................................+---+---+---+...............+---+---+---+---+---+ |.....+---+---+---+---+---+ |.....+---+ |.....+---+ |.................................+---+---+---+...................+---+---+---+---+ |.....+---+---+---+---+---+ |.....+---+---+..........
........|   |  /   /|   |   | +..../   /|   |   |  /   /|.......|   |  /   /|   |   | +..../   /| +................/   /|   | +..../   /| +................/   /|   |  /   /| +..../   /   /|....../   /| +..../   /|   |   |   | +..................../   /| +................/   /| +.....|  /   /|................../   /|   | +......../   /|   |   |   |   | +..................................../   /|  /   /|............../   /|   |   |   |   | +..../   /|   |   |   |   | +..../   /| +..../   /| +................................/   /|  /   /|................../   /|   |  /   /| +.....|   |  /   /|   |   | +.....|  /   /|..........
........|   | +---+ |   |   |/....+---+---+---+---+---+ |.......|   | +---+ |   |   |/....+---+ |/............+---+---+ |   |/....+---+ |/................+---+ |   | +---+ |/....+---+---+---+...+---+ |/....+---+ | +---+---+ |/....................+---+ |/................+---+ |/......| +---+---+...........+---+---+ |   |/........+---+---+---+---+ |   |/................................+---+---+---+---+---+...........+---+---+---+---+---+ |/....+---+ |   |   |   |   |/....+---+ |/....+---+ |/............................+---+---+---+---+---+...............+---+---+---+---+ |/......|   | +---+ |   |   |/......| +---+---+........
........+---+/   /| +---+---+..../   /   /   /   /|   | +.......+---+/   /| +---+---+..../   /| +............/   /|   | +---+..../   /| +................/   /| +---+/   /| +..../   /|  /   /|../   /| +..../   /| +/   /   /|-+..................../   /| +................/   /| +.......+-|  /   /|........../   /|   | +---+......../   /   /   /   /|-+---+................................/   /   /   /   /   /|........../   /   /   /   /   /|-+..../   /| +---+---+---+---+..../   /| +..../   /| +............................/   /   /   /   /   /|............../   /   /   /|   | +.......+---+/   /| +---+---+.......+-|  /   /|........
............+---+ |/............+---+---+---+---+---+ |/............+---+ |/............+---+ |/............+---+---+ |/........+---+ |/................+---+ |/....+---+ |/....+---+ | +---+---+---+ |/....+---+ |/+---+---+ |.....................+---+ |/................+---+ |/..........| +---+---+...+---+---+ |   |/............+---+---+---+---+ |.................................+---+---+---+---+---+---+---+.......+---+---+---+---+---+ |.....+---+ |/....................+---+ |/....+---+ |/........................+---+---+---+---+---+---+---+...........+---+---+---+ |   |/............+---+ |/................+---+---+ |........
.........../   /| +............/   /|   |   |  /   /|-+............/   /| +............/   /| +.............|  /   /|-+......../   /| +................/   /| +..../   /| +..../   /| +-|  /   /   /| +..../   /| +.|  /   /| +..................../   /| +................/   /| +...........+-|  /   /|../   /|   | +---+............/   /|   |   |   | +................................/   /|   |   |   |   |  /   /|.......|   |   |   |  /   /| +..../   /| +..................../   /| +..../   /| +......................../   /|   |   |   |   |  /   /|........../   /|  /   /| +---+............/   /| +................/   /|   | +........
..........+---+ |/............+---+---+---+---+---+ |.............+---+ |/............+---+---+---+---+.....| +---+---+.......+---+---+---+---+.......+---+---+---+---+ |/....+---+ |/..| +---+---+ |/....+---+---+---+---+ |/+---+---+---+---+...+---+---+---+---+.......+---+ |/..............| +---+---+---+ |   |/................+---+---+---+---+---+.......+---+---+---+---+...+---+---+ |   |   |   |   | +---+---+...+---+---+---+---+---+ |/....+---+---+---+---+---+.......+---+ |/....+---+ |/+---+---+---+---+...+---+---+ |   |   |   |   | +---+---+.......+---+ | +---+---+...............+---+ |/............+---+---+ |   |/.........
........./   /| +............/   /   /   /   /|   | +............/   /| +............/   /   /   /   /|.....+-|  /   /|....../   /   /   /   /|....../   /   /   /   /| +..../   /| +...+-|  /   /| +..../   /   /   /   /| +/   /   /   /   /|../   /   /   /   /|....../   /| +...............+-|  /   /|   | +---+................/   /   /   /   /   /|....../   /   /   /   /|../   /|   | +---+---+---+---+-|  /   /|../   /   /   /   /   /| +..../   /   /   /   /   /|....../   /| +..../   /| +/   /   /   /   /|../   /|   | +---+---+---+---+-|  /   /|....../   /| +-|  /   /|............../   /| +............/   /|   | +---+..........
........+---+ |/............+---+---+---+---+ |   |/............+---+ |/............+---+---+---+---+ |.......| +---+ |.....+---+---+---+---+ |.....+---+---+---+---+ |/....+---+ |/......| +---+ |/....+---+---+---+---+ |/+---+---+---+---+ |.+---+---+---+---+ |.....+---+ |/..................| +---+ |   |/....................+---+---+---+---+---+ |.....+---+---+---+---+ |.+---+ |   |/..................| +---+ |.+---+---+---+---+---+ |/....+---+---+---+---+---+ |.....+---+ |/....+---+ |/+---+---+---+---+ |.+---+ |   |/..................| +---+ |.....+---+ |/..| +---+ |.............+---+ |/............+---+ |   |/...............
........|   | +.............|   |   |   |   | +---+.............|   | +.............|   |   |   |   | +.......+-|   | +.....|   |   |   |   | +.....|   |   |   |   | +.....|   | +.......+-|   | +.....|   |   |   |   | +.|   |   |   |   | +.|   |   |   |   | +.....|   | +...................+-|   | +---+.....................|   |   |   |   |   | +.....|   |   |   |   | +.|   | +---+...................+-|   | +.|   |   |   |   |   | +.....|   |   |   |   |   | +.....|   | +.....|   | +.|   |   |   |   | +.|   | +---+...................+-|   | +.....|   | +...+-|   | +.............|   | +.............|   | +---+................
........|   |/..............|   |   |   |   |/..................|   |/..............|   |   |   |   |/..........|   |/......|   |   |   |   |/......|   |   |   |   |/......|   |/..........|   |/......|   |   |   |   |/..|   |   |   |   |/..|   |   |   |   |/......|   |/......................|   |/..........................|   |   |   |   |   |/......|   |   |   |   |/..|   |/..........................|   |/..|   |   |   |   |   |/......|   |   |   |   |   |/......|   |/......|   |/..|   |   |   |   |/..|   |/..........................|   |/......|   |/......|   |/..............|   |/..............|   |/.....................
........#---#...............#---#---#---#---#...................#---#...............#---#---#---#---#...........#---#.......#---#---#---#---#.......#---#---#---#---#.......#---#...........#---#.......#---#---#---#---#...#---#---#---#---#...#---#---#---#---#.......#---#.......................#---#...........................#---#---#---#---#---#.......#---#---#---#---#...#---#...........................#---#...#---#---#---#---#---#.......#---#---#---#---#---#.......#---#.......#---#...#---#---#---#---#...#---#...........................#---#.......#---#.......#---#...............#---#...............#---#......................
```